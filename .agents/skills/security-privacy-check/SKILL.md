---
name: security-privacy-check
description:
  PR/差分を根拠ベースで確認し、秘密情報漏えい、個人情報ログ出力、認可漏れ、外部送信などのセキュリティ・プライバシーリスクを指摘する
---

<!--
使い方テンプレ（コピペ用）:

`security-privacy-check` を使って、`git diff --staged` をセキュリティ/プライバシー観点でレビューして。
P0/P1/P2で重大度をつけて、根拠（ファイル名＋行範囲）と具体的な修正案を短く出して。
不明点があれば推測せず、確認コマンドも書いて。
-->

# Security & Privacy Check（ToneTwo）

## ゴール
PR/差分を根拠ベースで確認し、以下を短く出す：
- 何が漏れる/危ないか（秘密情報、個人情報、本文ログ、認可漏れ、外部送信など）
- マージ前に直すべきもの（P0/P1）と、後回し可（P2）
- 不明点があれば「不明」と明示し、確認手順を提示して止まる

## 絶対ルール
- 推測で進めない。根拠が不足なら「情報不足」として止める。
- 依存/仕様の判断はローカル（lockfile等）を一次情報にする。
- コマンド実行が必要な場合は、実行前に「何を・なぜ」やるかを説明し、必要なら承認を求める。
- レビュー範囲は原則として、依頼された差分（例: `git diff --staged`）のみに限定する。履歴全体の秘密情報混入有無は、明示依頼がない限り不明点として挙げない。
- 原則は staged 差分固定とし、ユーザーが明示した場合のみ working diff（`git diff`）レビューへ切り替える。

## 入力として集めるもの（順）
1) 差分範囲（どれか1つでOK）
- staged: `git diff --staged`
- working: `git diff`
- base比較: `git diff origin/main...HEAD`（またはデフォルトブランチ）

2) 変更ファイル一覧
- `git diff --name-only <range>`

3) 変更領域を分類（ざっくり）
- 認証/認可・セッション・Cookie
- チャット/メッセージ本文・通報/モデレーション
- メール送信・Webhook・外部API
- ログ・エラートラッキング・分析
- DBスキーマ（migration）
- アップロード/ストレージ
- 管理系機能

4) staged が空の場合の確認フロー
- `git diff --staged` が空なら、現在ブランチ名を表示する（`git branch --show-current`）。
- ユーザーに「このブランチで `git add` してよいか」を確認する。
- ユーザー確認が取れるまで staged 前提レビューを進めない。

## 既知・対応済み事項（最初に確認）
- レビュー開始時に、対象差分内の `TODO` コメントを先に確認し、既知リスクかどうかを判定する。
- 既知リスク（すでに合意済み・対応計画あり）は `Known Risk` として別枠で出力する。
- 既知リスクは原則 P1/P2 に再計上しない。
- ただし新規差分で悪化（影響拡大・保護低下・露出増）が確認できた場合のみ、P1/P2 に再昇格して指摘する。

---

## チェック項目（根拠ベース）

### A. 秘密情報/認証情報の漏えい（P0）
探すもの：
- `.env*`、APIキー、トークン、クレデンシャル、秘密鍵
- Authorizationヘッダ、リセットURL、招待リンク等をログ/出力していないか

推奨スキャン（`rg`）：
- `rg -n "(AKIA[0-9A-Z]{16}|gho_[A-Za-z0-9_]{20,}|sk-[A-Za-z0-9]{20,}|BEGIN (RSA|OPENSSH|EC) PRIVATE KEY)" -S`
- `rg -n "(Authorization:|bearer |api[_-]?key|secret|token|password)" -S`

見つけたら：
- P0（即修正）。値はレポートに貼らず必ず伏せる。
- 対応案：コミットから除外/履歴除去の検討、キーのローテ、gitignore、env/credentialsへ移動。

### B. ログへの個人情報・本文出力（P0/P1）
危険サイン：
- `logger.*(params|request|headers|cookies)` / `puts params` / `pp params`
- メッセージ本文、メールアドレス、IP、トークン等をログ出力
- デバッグログが残ったまま

観点：
- 「必要最小限」だけログに残す（本文/メール/トークンは原則NG）
- パラメータフィルタ（`filter_parameters`）で十分か、追加が必要か

### C. 新規保存データ（PII/機微情報）と保持方針（P1）
差分で新しいカラム/保存が増えたら：
- 本当に保存が必要か（目的）
- どれくらい保持するか（削除/匿名化/退会時の扱い）
- 既存ポリシー/プライバシーポリシー追記が必要か

### D. 認証/認可（AuthN/AuthZ）と公開エンドポイント（P0/P1）
見るところ：
- 新規アクションに認証必須のはずなのにガードがない
- トークンURL：期限、使い捨て、リプレイ耐性
- ID指定で他人のデータに触れうる（IDOR）

### E. Cookie/Session/CSRF/HTTPS（P1）
触れていたら確認：
- Cookieの `Secure` / `HttpOnly` / `SameSite`
- CSRFが無効化されていないか
- HTTPS前提（プロキシ配下含む）の設定が崩れていないか

### F. 外部送信（メール/分析/監視/ストレージ等）と最小化（P1/P2）
外部に送るデータが増えたら：
- 何を送っているか（本文/メール/識別子等）
- 最小化できないか（不要なフィールドは送らない・マスキング）
- プライバシーポリシー等の追記要否

---

## 出力形式（短く）
1) サマリ
- 総合リスク：Low / Medium / High
- Must-fix（P0/P1）件数

2) 指摘（重大度順）
各項目に必ず：
- 重大度：P0 / P1 / P2
- 種別：secrets / logs / storage / auth / cookies / third-party / docs
- 根拠：ファイル名 + 位置（行範囲 or 短い抜粋）
- 影響：何が起きうるか
- 対応：具体策（必要ならパッチ案）

3) Known Risk（既知・対応済み事項）
- 根拠：ファイル名 + 位置（行範囲 or 短い抜粋）
- 現在の扱い：既知リスクとして継続監視 / 対応予定
- 再昇格条件：どの変更が入ったら P1/P2 に戻すか

4) 不明点（No evidence / Unknown）
- 確認できなかった点
- 確認に必要なコマンド/ファイル

---

## 「理解不足」と言われたら
- 3〜6文で短く説明（専門用語は最初に一言定義）。
- そのあと「今回やるべきアクション」を1行で言い切る。

---

## 参考（一次ソースの正式名称）
- OpenAI Codex Skills / Create a skill（公式ドキュメント）
- Ruby on Rails Guides: Security / Configuring / Active Record Encryption
- OWASP Cheat Sheet Series: Logging / Secrets Management / User Privacy Protection
