#  MeCab(NEologd+ユーザー辞書)をDocker本番構成に導入

## 目的
- ローカル本番環境（`docker-compose.localprod.yml`）で MeCab（NEologd + user.dic）を使った形態素解析ができることを確認する
- Rails（Natto）からも **同じ辞書（NEologd + user.dic）** を参照できる状態にする

## 結論(構成方針)
- **build ステージ**
  - MeCab + NEologd をインストール
  - `mecab_userdic/user.csv` から `user.dic` を生成
  - NEologd 辞書 + user.dic を `/opt/mecab-dic/` に退避（固定パス）
- **runtime ステージ**
  - MeCab 実行に必要な最小パッケージのみ入れる
  - build で退避した辞書を runtime へ `COPY`
  - natto 用に `MECAB_PATH` を設定して `libmecab.so` を解決させる
  - Rails（Natto）が参照する辞書パスを **ENVで固定**する
    - `MECAB_DICDIR=/usr/local/lib/mecab/dic/mecab-ipadic-neologd`
    - `MECAB_USER_DIC=/usr/local/lib/mecab/dic/user.dic`

---

## ディレクトリ / ファイル
- `mecab_userdic/user.csv`
  - Git管理するユーザー辞書ソース
- `user.dic`
  - **Git管理しない**（buildで生成）
- runtime側の辞書配置
  - `/usr/local/lib/mecab/dic/mecab-ipadic-neologd/`
  - `/usr/local/lib/mecab/dic/user.dic`

## 手順
1. baseの`apt-get`にMecab/NEologで使用するパッケージを追加
```sh
# ====================
#  MeCab（本体 + 補助コマンド + 開発ヘッダ + IPA辞書）
# ====================
mecab \
libmecab-dev \
mecab-ipadic-utf8 \
mecab-utils \
mecab-ipadic \
libmecab2 \
# ====================
# NEologdのインストールに必要な追加パッケージ群
# ====================
# .xz 形式で圧縮された辞書データやコーパスを展開するため
xz-utils \
# ファイルにパッチを当てる（NEologd のセットアップで辞書定義やビルド用ファイルに修正を当てる工程がある）
patch \
# ファイル種別を判定するコマンド。インストーラが「これは何のファイルか」を確認するのに使うことがある。
file \
# sudo 権限でインストール
# !=> セキュリティ的に問題があるので本番環境ではビルド時のみ実装すること
# !Todoビルド時のみの導入でNEologdの動作に問題ないか要確認
sudo \
```

2. `Dockerfile.localprod`のビルドステージにNEologd + user.dicの導入を追記
ポイント：
- `mecab-dict-index` はパスエラーになるケースがあるため、`mecab-config --libexecdir` から **絶対パスで呼ぶ**
- 同様にパスエラーを回避するためNEologdの辞書ディレクトリは`mecab-config --dicdir` から取得する

```Dockerfile
# ====================
#  NEologdのインストール
#  NEologdは重くたまに失敗するので5回までリトライする
# ====================
# set -eux: Dockerビルドのデバッグをしやすくする定番セット
# -e:エラー時に即座に終了 -u:未定義の変数を使ったらエラー -x:実行するコマンドをログに全部出力
RUN set -eux; \
  # NEologdのインストールを最大5回までリトライ
  for i in 1 2 3 4 5; do \
    # 毎回クローンキャッシュを削除してから実行
    rm -rf /tmp/mecab-ipadic-neologd; \
    # NEologdのGitクローン(公式手順に準拠) --depth 1: 履歴を1つだけにして軽量化
    if git clone --depth 1 https://github.com/neologd/mecab-ipadic-neologd.git /tmp/mecab-ipadic-neologd && \
      # インストールを実行(公式手順に準拠)
      # -y:全てyesで実行
      # -n: ログからインストーラの更新/更新チェック挙動に関わるオプションっぽい、詳細不明
      /tmp/mecab-ipadic-neologd/bin/install-mecab-ipadic-neologd -n -y; then \
      rm -rf /tmp/mecab-ipadic-neologd; \
      # RUN ステップを成功で終了
      exit 0; \
    fi; \
    # >&2: 標準エラー出力にメッセージを出す
    echo "NEologd install failed. retry=${i}" >&2; \
    # バックオフ戦略: リトライ毎に待機時間を長くする(混雑や一時障害に強い)
    # 例: 1回目=10秒, 2回目=20秒, 3回目=30秒...
    sleep $((i*10)); \
  # forループここまで
  # 5回リトライしても成功しなかった場合の処理
  done; \
  echo "NEologd install failed after retries" >&2; \
  # exit 1：RUNステップが失敗 → Dockerビルド全体が失敗
  exit 1

# ====================
#  NEologd辞書の退避 + user.dic 生成
# ====================

# user辞書ソースだけ先にコピー
COPY mecab_userdic/user.csv ./mecab_userdic/user.csv

RUN set -eux; \
  # パスブレを防ぐために変数に格納
  # MeCabの"辞書ディレクトリ"を取得
  DICDIR="$(mecab-config --dicdir)"; \
  # MeCabの“実行補助コマンド置き場”を取得
  LIBEXECDIR="$(mecab-config --libexecdir)"; \
  # mecab-dict-index コマンドのパスを変数にセット
  MECAB_DICT_INDEX="${LIBEXECDIR}/mecab-dict-index"; \
  mkdir -p /opt/mecab-dic; \
  # NEologd辞書を固定パスへ退避
  cp -a "${DICDIR}/mecab-ipadic-neologd" /opt/mecab-dic/; \
  # user.csv から user.dic を生成
  "${MECAB_DICT_INDEX}" \
    -d "${DICDIR}/mecab-ipadic-neologd" \
    -u /opt/mecab-dic/user.dic \
    -f utf-8 -t utf-8 \
    /rails/mecab_userdic/user.csv
```
3. `runtime`の`apt-get`にMecabを追加
```sh
# ====================
#  MeCab（本体 + ランタイムライブラリ）
# ====================
mecab \
libmecab2 \
```

4. `runtime`に`ipadic-neologd + user.dic`のコピーを配置
```sh
# MeCab辞書の配置先を作成
RUN mkdir -p /usr/local/lib/mecab/dic

# buildで退避した辞書をruntimeへコピー
COPY --from=build /opt/mecab-dic/mecab-ipadic-neologd \
  /usr/local/lib/mecab/dic/mecab-ipadic-neologd

COPY --from=build /opt/mecab-dic/user.dic \
/usr/local/lib/mecab/dic/user.dic
```

5.  Dockerfile(base) で ENV を固定する ( 2026-01-07追記 )
    - 本番環境では mecab-config を使わず、固定パスを参照する。
    - そのため `Dockerfile.localprod(base)`で ENV を固定する。
      - runtime でもOKだけど構成変更に強くするために念のためbaseに置く
```Dockerfile
ENV MECAB_DICDIR="/usr/local/lib/mecab/dic/mecab-ipadic-neologd" \
    MECAB_USER_DIC="/usr/local/lib/mecab/dic/user.dic" \
```


6. nattoのパスブレ対策で、`MECAB_PATH` は `Dockerfile.localprod(runtime)`のENVで固定
```Dockerfile
# natto が libmecab.so を見つけられるようにする
ENV MECAB_PATH=/usr/lib/x86_64-linux-gnu/libmecab.so.2 \
```

7. `Dockerfile`(本番用)に今回作成した`Dockerfile.localprod`をコピペ
- baseの`apt-get`から`sudo`パッケージを削除

## 動作確認（ローカル本番）
1.　辞書ファイルが配置されているか
```sh
make lprod-exec
ls -lah /usr/local/lib/mecab/dic | sed -n '1,80p'
ls -lah /usr/local/lib/mecab/dic/user.dic
```

2. natto が libmecab を解決できるか
```sh
echo "$MECAB_PATH"
ls -la /usr/lib/x86_64-linux-gnu/libmecab.so*
ldconfig -p | grep mecab || true
```

3. MeCab の動作 NEologd + user.dicを使った解析ができているか
```sh
echo "うざい" | mecab -d /usr/local/lib/mecab/dic/mecab-ipadic-neologd -u /usr/local/lib/mecab/dic/user.dic
```
4. Rails（Natto）からも同じ辞書を参照できるか
```sh
bin/rails runner '
analyzer = Mecab::Analyzer.new
tokens = analyzer.tokens(%q[しか勝たん])
p tokens.map { |t| [t[:surface], t[:base], t[:pos]] }
'
```

## トラブルシュート
- `mecab-dict-index: not found`のエラー
  - `mecab-dict-index` が PATH に無いだけの可能性が高い
  - 対策：`mecab-config --libexecdir` から絶対パスで呼ぶ

- nattoが`Please set MECAB_PATH to the full path to libmecab.so`で落ちる
  - MECAB_PATH が未設定 or 指しているパスが違う
  - 対策：`ls -la /usr/lib/x86_64-linux-gnu/libmecab.so*` で実在確認し、Dockerfile の `ENV MECAB_PATH=...` で指定

- Rails（Natto）が別の辞書パスを参照して落ちる
  - `--dicdir=...` / `--userdic=...` が想定とズレている可能性
  - 対策：
    - Dockerfile で `MECAB_DICDIR / MECAB_USER_DIC` を固定
    -` Mecab::Analyzer` は `production` で固定パス（ENV）を参照する実装に変更

## メモ
- `user.dic` はバイナリで差分管理に向かない＆環境次第で意図せず壊れることがあるため、Git管理しない方針に変更。`.gitignore`と`Dockerfile.dev`ファイルも修正済み。


## 参考
- MeCab公式: https://taku910.github.io/mecab/
- natto（GitHub）: https://github.com/buruzaemon/natto
- mecab-ipadic-neologd(GitHub):
 https://github.com/neologd/mecab-ipadic-neologd
- Manpages of manpages-ja in Debian testing : https://manpages.debian.org/testing/manpages-ja/index.html
- Docker ドキュメント日本語化プロジェクト(RUN) :https://docs.docker.jp/develop/develop-images/dockerfile_best-practices.html#run
