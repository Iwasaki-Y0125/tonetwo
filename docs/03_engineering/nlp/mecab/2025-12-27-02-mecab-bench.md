# MeCabï¼ˆNEologd + user.dicï¼‰åè©æŠ½å‡ºã®ç°¡æ˜“ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯

## ç›®çš„
- åè©æŠ½å‡ºï¼ˆMecab::NounExtractorï¼‰ãŒæŠ•ç¨¿å‡¦ç†ã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã«ãªã‚‰ãªã„ã‹ã€MVPæ™‚ç‚¹ã§ã€Œ1æŠ•ç¨¿ã‚ãŸã‚Šä½•msãã‚‰ã„ã‹ã€ã‚’é›‘ã«æŠŠæ¡ã™ã‚‹
- è¾æ›¸å¤‰æ›´ã‚„å®Ÿè£…å¤‰æ›´ã®å‰å¾Œã§æ¯”è¼ƒã§ãã‚‹ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã‚’ä½œã‚‹

## çµè«–
- devç’°å¢ƒã®ç°¡æ˜“è¨ˆæ¸¬ã§ã¯ã€åè©æŠ½å‡ºã¯ ä¸­å¤®å€¤ 0.081ms / p95 0.332ms / p99 0.661msï¼ˆn=3600ï¼‰ ç¨‹åº¦ã§å‹•ä½œã—ãŸï¼ˆã‚µãƒ³ãƒ—ãƒ«12ä»¶Ã—å„300å›ï¼‰ã€‚
- æœ€å¤§å€¤ã¯ 12.159msï¼ˆ0.012ç§’ï¼‰ ã¨å¤–ã‚Œå€¤ãŒå‡ºã‚‹ãŒã€ä»£è¡¨å€¤ã¨ã—ã¦ã¯ p95/p99 ã‚’é‡è¦–ã™ã‚‹ã€‚
- ãƒ™ãƒ³ãƒå®Ÿè¡Œæ™‚ã« [check] ãƒ­ã‚°ã§åè©æŠ½å‡ºçµæœã‚’ç¢ºèªã§ãã€å‡¦ç†ãŒå®Ÿéš›ã«å‹•ã„ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ãŸã€‚

## å¤‰æ›´ç‚¹
- `script/bench_noun_extractor.rb` ã‚’è¿½åŠ 
  - `warmup` + è¨ˆæ¸¬ã‚’å®Ÿæ–½ã—ã€`min/max/avg/median/p95/p99` ã‚’ `ms` ã§å‡ºåŠ›
  - å‹•ä½œç¢ºèªç”¨ã«æœ€åˆã®1ä»¶ã ã‘ `sample` ã¨ `nouns` ã‚’å‡ºåŠ›

- ã‚µãƒ³ãƒ—ãƒ«æŠ•ç¨¿ã‚’å…±é€šåŒ–
  - `script/mecab_samples.rb` ã« `MecabSamples::SAMPLES` ã‚’åˆ‡ã‚Šå‡ºã—ã€ä»–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã‚‚ä½¿ã„å›ã›ã‚‹ã‚ˆã†ã«ã—ãŸ

## æ‰‹é †
1. ãƒ™ãƒ³ãƒç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’é…ç½®
    - `script/bench_noun_extractor.rb`
    ```ruby
    # script/bench_noun_extractor.rb

    # ä½¿ã„æ–¹:
    # docker compose --env-file .env.dev -f docker-compose.dev.yml \
    #   exec -e HOME=/tmp --user 1000:1000 web \
    #   bin/rails runner script/bench_noun_extractor.rb


    require "json"
    require_relative "mecab_samples"

    analyzer = Mecab::Analyzer.new
    extractor = Mecab::NounExtractor.new(analyzer: analyzer)

    # å‹•ä½œç¢ºèª
    text = MecabSamples::SAMPLES.first
    warn "[check] sample=#{text.inspect}"
    warn "[check] nouns=#{extractor.call(text).inspect}"

    # åè©æŠ½å‡ºå™¨ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
    def run_once(extractor, text)
      extractor.call(text)
    end

    SAMPLES = MecabSamples::SAMPLES

    # ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯è¨­å®š
    WARMUP = 30
    N_PER_SAMPLE = 300

    # ãƒŸãƒªç§’ã«å¤‰æ›
    def ms(t) = t * 1000.0

    times = []

    # äºˆå‚™å®Ÿè¡Œ
    WARMUP.times do |i|
      run_once(extractor, SAMPLES[i % SAMPLES.size])
    end

    # æœ¬è¨ˆæ¸¬
    SAMPLES.each do |text|
      N_PER_SAMPLE.times do
        t0 = Process.clock_gettime(Process::CLOCK_MONOTONIC)
        run_once(extractor, text)
        t1 = Process.clock_gettime(Process::CLOCK_MONOTONIC)
        times << (t1 - t0)
      end
    end

    # çµæœé›†è¨ˆ
    sorted = times.sort
    n = sorted.size
    min = sorted.first
    max = sorted.last
    avg = sorted.sum / n
    median = sorted[n / 2]
    p95 = sorted[(n * 0.95).floor]
    p99 = sorted[(n * 0.99).floor]

    # çµæœå‡ºåŠ›
    puts({
      n: n,
      min_ms: ms(min).round(3),
      max_ms: ms(max).round(3),
      avg_ms: ms(avg).round(3),
      median_ms: ms(median).round(3),
      p95_ms: ms(p95).round(3),
      p99_ms: ms(p99).round(3),
    }.to_json)
    ```


2. ã‚µãƒ³ãƒ—ãƒ«æŠ•ç¨¿ã‚’åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ‡ã‚Šå‡ºã—
    - `script/mecab_samples.rb`

    ```ruby
    # frozen_string_literal: true

    module MecabSamples
      SAMPLES = [
        # topic: ã‚¯ãƒªã‚¹ãƒã‚¹/é£Ÿã¹ç‰©, sentiment: +
        "ä»Šå¹´ã®ã‚¯ãƒªã‚¹ãƒã‚¹ã¯ã‚¬ã‚¹ãƒˆã®ä¸¸ã©ã‚Šãƒã‚­ãƒ³è²·ã£ãŸï¼æ¥½ã—ã¿ã€œğŸ„ğŸ—",

        # topic: ã‚¯ãƒªã‚¹ãƒã‚¹/ä»•äº‹/å¯’ã•, sentiment: -
        "ã‚¯ãƒªã‚¹ãƒã‚¹ãªã®ã«ä»•äº‹ã ã‚‹ã„ã€‚ã€‚ã€‚ğŸ˜©ã‚ã£ã¡ã‚ƒå¯’ã„ã—ã€‚ã€‚ã€‚æœ€æ‚ª",

        # topic: ã‚¯ãƒªã‚¹ãƒã‚¹/é£Ÿã¹ç‰©, sentiment: +
        "ã‚¯ãƒªã‚¹ãƒã‚¹ã¯æ¬¡ã®æ—¥ã«å®‰å£²ã‚Šã•ã‚Œã‚‹ã‚±ãƒ¼ã‚­ã‚’è²·ã†ã®ãŒæ¥½ã—ã¿ãªã‚“ã ã‚ˆã­",

        # topic: ã‚¯ãƒªã‚¹ãƒã‚¹/éŸ³æ¥½, sentiment: +
        "ã‚¯ãƒªã‚¹ãƒã‚¹ã‚½ãƒ³ã‚°ã¯ç¾Šæ–‡å­¦ã®1999ãŒä¸€ç•ªå¥½ãï¼ https://example.com",

        # topic: ã‚¯ãƒªã‚¹ãƒã‚¹/éŸ³æ¥½, sentiment: -
        "è¡—ä¸­ã§ã‚¯ãƒªã‚¹ãƒã‚¹ã‚½ãƒ³ã‚°æµã‚Œã¦ã‚‹ã®ã†ã–ã„ã‹ã‚‰ã‚„ã‚ã¦ã»ã—ã„",

        # topic: ã‚¯ãƒªã‚¹ãƒã‚¹/æ˜ ç”», sentiment: +
        "ã‚¯ãƒªã‚¹ãƒã‚¹ã®æ˜ ç”»ã¨ã„ãˆã°ã€ãƒ›ãƒ¼ãƒ ãƒ»ã‚¢ãƒ­ãƒ¼ãƒ³ã€ã ã‚ˆã­ï¼ç¬‘ãˆã‚‹ã—æ„Ÿå‹•ã‚‚ã™ã‚‹ã—æœ€é«˜ï¼å½¼æ°ã¨è¦³ã‚‹äºˆå®šğŸ˜ŠğŸ¤",

        # topic: ã‚¯ãƒªã‚¹ãƒã‚¹/æ˜ ç”», sentiment: +
        "ã‚¯ãƒªã‚¹ãƒã‚¹ã®æ˜ ç”»ã¨ã„ãˆã°ã€Œæ±äº¬ã‚´ãƒƒãƒˆãƒ•ã‚¡ã‚¶ãƒ¼ã‚ºã€ã§ã—ã‚‡ã€‚ç¬‘ã„ã‚ã‚Šæ¶™ã‚ã‚Šã®åä½œã€‚ä»Šæ•ç›£ç£ã£ã½ã„ã©ã“ã‹ä¸æ°—å‘³ãªæ„Ÿã˜ã‚‚ã‚ˆãã€‚ã²ã•ã³ã•ã«è¦³ãŸã‘ã©ã‚„ã£ã±å¥½ãã ãªã‚ã€‚å¸ƒæ•™ã—ã‚ˆã†ã‹ãª",

        # topic: æ˜ ç”», sentiment: +
        "æ˜ ç”»ã¨ã„ãˆã°ã€Œæ±äº¬ã‚´ãƒƒãƒˆãƒ•ã‚¡ã‚¶ãƒ¼ã‚ºã€ã§ã—ã‚‡ã€‚ç¬‘ã„ã‚ã‚Šæ¶™ã‚ã‚Šã®åä½œã€‚ä»Šæ•ç›£ç£ã£ã½ã„ã©ã“ã‹ä¸æ°—å‘³ãªæ„Ÿã˜ã‚‚ã‚ˆãã€‚ã²ã•ã³ã•ã«è¦³ãŸã‘ã©ã‚„ã£ã±å¥½ãã ãªã‚ã€‚å¸ƒæ•™ã—ã‚ˆã†ã‹ãª",

        # topic: æ˜ ç”», sentiment: -
        "ã€Œãƒ‘ãƒ—ãƒªã‚«ã€ã™ã™ã‚ã‚‰ã‚Œã¦è¦‹ãŸã‘ã©ã€ãªã‚“ã‹é›£ã—ãã¦ã‚ˆãã‚ã‹ã‚‰ãªã‹ã£ãŸã€‚ä»Šæ•ç›£ç£ã®ã»ã‹ã®ä½œå“ã‚‚å‰è¦‹ãŸã“ã¨ã‚ã‚‹ã‘ã©ã‚ã‚“ã¾ã‚Šå¥½ãã˜ã‚ƒãªã‹ã£ãŸãªã‚",

        # topic: äººé–“é–¢ä¿‚/é›‘è«‡, sentiment: 0
        "æœ€è¿‘ãƒå…ˆã®äººãŒã‚µãƒ–ã‚«ãƒ«ã‚ã‹ã£ã¦ã‚‹æ„Ÿå‡ºã—ã¦ã‹ã£ã“ã¤ã‘ã¦ãã‚‹ã®ã¾ã˜ã‚¦ã‚±ã‚‹ç¬‘",

        # topic: å‹•ç‰©/å¤¢/ç”Ÿæ´», sentiment: +
        "ã„ã¤ã‹å¤§å‹çŠ¬ã‚’é£¼ã„ãŸã„ã€‚ã„ã£ã±ã„ãŠé‡‘ç¨¼ã„ã§åºƒã„åº­ã¤ãã®å¤§ãã„æˆ¸å»ºã¦ã«ä½ã¿ãŸã„ã€‚å¤¢ã¯å¤§ããï¼",

        # topic: å‹•ç‰©, sentiment: +
        "çŒ«ã‹ã‚ã„ã„ğŸˆçŒ«ã—ã‹å‹ãŸã‚“"
      ].freeze
    end
    ```

3. ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ runner å®Ÿè¡Œ
    ```sh
    docker compose --env-file .env.dev -f docker-compose.dev.yml \
      exec -e HOME=/tmp --user 1000:1000 web \
      bin/rails runner script/bench_noun_extractor.rb
    ```

## å‹•ä½œç¢ºèª
å®Ÿè¡Œãƒ­ã‚°ä¾‹

```sh
[check] sample="ä»Šå¹´ã®ã‚¯ãƒªã‚¹ãƒã‚¹ã¯ã‚¬ã‚¹ãƒˆã®ä¸¸ã©ã‚Šãƒã‚­ãƒ³è²·ã£ãŸï¼æ¥½ã—ã¿ã€œğŸ„ğŸ—"
[check] nouns=["ä»Šå¹´", "ã‚¯ãƒªã‚¹ãƒã‚¹", "ã‚¬ã‚¹ãƒˆ", "ä¸¸ã©ã‚Š", "ãƒã‚­ãƒ³", "æ¥½ã—ã¿"]
{"n":3600,"min_ms":0.023,"max_ms":12.159,"avg_ms":0.135,"median_ms":0.081,"p95_ms":0.332,"p99_ms":0.661}
```


## è£œè¶³
- æœ¬çµæœã¯ devç’°å¢ƒã§ã®ç°¡æ˜“è¨ˆæ¸¬ã®ãŸã‚ã€å…¨ä½“ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å®Œæˆå¾Œã« localprod / æœ¬ç•ªç›¸å½“ç’°å¢ƒã§ã‚‚åŒæ§˜ã«å†è¨ˆæ¸¬ã—ã€å·®åˆ†ã‚’è¦‹ã‚‹ã€‚
- `max` ã¯ GCã‚„OSã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ç­‰ã®å½±éŸ¿ã§å¤–ã‚Œå€¤ã«ãªã‚Šã‚„ã™ã„ãŸã‚ã€æ¯”è¼ƒãƒ»åˆ¤æ–­ã«ã¯ `p95/p99` ã‚’å„ªå…ˆã™ã‚‹ã€‚
