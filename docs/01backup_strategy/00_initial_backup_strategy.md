# Backup Strategy (Initial)

本ドキュメントは、実装前にToneTwoの**初期運用（低コスト・シンプル重視）**におけるバックアップ方針をまとめたものです。
実際の具体的な運用手順（コマンド、Runbook、復旧手順の詳細）は、**運用開始後に確定・追記**します。

---

## 目的と前提

- **月額コストを抑える**（初期運用）
- まずは「初期にありがちな事故」への耐性を作る
  - 人的事故：誤DELETE / 誤UPDATE / 誤DROP
  - うっかり削除：DBインスタンス削除、保持期限切れ など
- 役割分担として、短期はPITR、長期と削除事故はオフサイトdumpでカバーする

---

## 方針

### A. Render有料DB + PITR（短期の巻き戻し）

- 人的事故（誤DELETE / 誤UPDATE / 誤DROP）は **PITR** で巻き戻して復旧する
- PITRの保持期間
  - **Hobby：過去3日**
  - **Professional以上：過去7日**
- この期間内の事故であれば、dumpより細かい粒度で戻せるのが強み

### B. オフサイト（Cloudflare R2）に日次dump（長期＆削除事故の保険）

- 1日1回、`pg_dump` を取得し **R2に保存**する。
- **実行基盤**：Render Cron Job を利用して定時実行（DB接続情報・R2キーは環境変数で渡す、コスト目安:現在のレートで月150円ぐらい）
- **アップロード先**：Cloudflare R2にバックアップファイルを保存する。
- 保持（ローテーション）
  - **日次：90日保持**
  - **月次：12ヶ月保持**
- 実装イメージ　　　　　　　　　　　　　　　
  - 日次dumpは90日で削除
  - **月初のdumpだけ別フォルダ（monthly/）にコピー**して12ヶ月保持
　
> オフサイトで「PITRの保持期間を超えて発覚した事故」や「DBインスタンス削除」のようなケースでも復旧できる可能性を残す。

---

## 最小ルール（運用しやすさ優先）

- 毎日定時にdumpを取得してR2へアップロード
- アップロード後、**復元テストを週1回**実施
  - Postgresコンテナに復元
  - `rails db:migrate` が通ること
  - 可能なら軽い疎通（例：簡単なクエリ、最小のRailsタスク等）
- 保持期間は以下で運用
  - 日次：90日
  - 月次：12ヶ月

---

## 復元テストの進め方

### Phase 1（最初の1〜2ヶ月）
- **手動で週1回**、ローカルDockerで復元テスト
  まずは仕組みを理解し、復元できることを体で覚える。

### Phase 2（慣れてきたら）
- GitHub Actionsで **週1回「DBが復元できるか」だけ自動化**
- Railsの本格的なシナリオテストは後回しでもOK（まず復元の成功を担保）

### Phase 3（余裕が出たら）
- **マスキング済みdump**を用意し、シナリオテストも自動化
  ※本番データをCIに載せない運用へ寄せる

---

## 注意点

- dump（バックアップ）は機密情報を含みうるため、保管先の権限や鍵管理に注意する
- バックアップは「取っていること」より「復元できること」が重要
  → 週1の復元テストを最小限として必ず回す
- 本番DB以外（例：アップロードファイル等）がある場合、別途バックアップ対象の整理が必要
  ※対象範囲は運用開始後に確定して追記する

---

## 参考メモ
- 失敗から学ぶRDBの正しい歩き方 曽根 壮大 (著) 技術評論社 第10章
